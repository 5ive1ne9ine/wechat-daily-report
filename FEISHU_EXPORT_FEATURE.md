# 飞书个人多维表格导出功能

## 功能概述

本功能支持将微信聊天记录导出到飞书个人多维表格中，支持AI智能分类和消息摘要。使用个人用户级API，文档将创建到您的个人飞书空间，便于个人管理和使用。

## 主要特性

### 1. 个人应用OAuth授权
- 使用飞书个人应用OAuth2.0授权流程
- 安全的用户身份验证
- 文档创建到个人飞书空间，便于管理
- 支持授权状态管理和令牌自动刷新

### 2. 智能数据处理
- **AI智能分类**：自动对消息进行分类（工作讨论、技术分享、日常闲聊等）
- **消息摘要**：对过长消息自动生成简洁摘要（不超过30字）
- **重要程度评估**：AI评估消息重要性（高/中/低）
- **关键词提取**：自动提取消息关键词

### 3. 灵活的导出配置
- 自定义时间范围导出
- 支持群聊和个人聊天
- 可选择是否启用AI分析
- 自定义表格名称

### 4. 表格字段说明

导出的个人多维表格包含以下字段：

| 字段名 | 类型 | 说明 |
|--------|------|------|
| 消息内容 | 文本 | 完整的消息内容 |
| 时间 | 文本 | 消息发送时间 |
| 发送人 | 文本 | 消息发送者 |
| 消息摘要 | 文本 | AI生成的消息摘要（长消息） |
| 消息类型 | 单选 | AI分类的消息类型 |
| 群名 | 文本 | 群聊或聊天对象名称 |
| 日期 | 日期 | 消息日期 |
| 重要程度 | 单选 | high/medium/low |
| AI分类 | 文本 | AI智能分类结果 |
| 关键词 | 文本 | 提取的关键词 |

## 使用步骤

### 第一步：创建飞书个人应用

1. 访问 [飞书开放平台](https://open.feishu.cn/app) 创建**个人应用**（注意：不是企业应用）
2. 在应用管理页面获取 `App ID` 和 `App Secret`
3. 在「安全设置」-「重定向URL」中添加：`http://localhost:3000/feishu/callback`
4. 在应用权限配置中开通「多维表格」相关权限
5. 在应用设置中填写获取的凭证信息和重定向URL

### 第二步：配置AI服务

确保已正确配置AI服务（OpenAI/OpenRouter等），用于智能分析功能。

### 第三步：配置Chatlog连接

确保Chatlog服务正常运行并已连接。

### 第四步：用户授权

1. 点击顶部导航栏的「飞书导出」按钮
2. 首次使用需要点击「开始飞书授权」
3. 在弹出的授权窗口中登录飞书并同意授权
4. 授权成功后显示用户信息

### 第五步：导出数据

1. 选择时间范围
2. 选择要导出的聊天对象
3. 配置导出选项（表格名称、是否启用AI分析）
4. 点击「开始导出」

## 技术实现

### 核心变化

- **认证方式**：从企业级`tenant_access_token`改为个人级`user_access_token`
- **授权流程**：实现完整的OAuth2.0授权流程
- **API端点**：使用个人用户级API端点
- **文档所有权**：文档创建到个人飞书空间

### 核心服务

- **FeishuService**: 负责飞书个人API集成
  - OAuth2.0授权流程管理
  - 用户访问令牌管理和自动刷新
  - 个人多维表格创建和管理
  - 批量数据写入

- **AI智能分析**: 
  - 消息内容分析和分类
  - 重要性评估
  - 关键词提取
  - 长消息摘要生成

### API调用优化

- 实现了用户访问令牌自动刷新机制
- 批量数据上传（每批100条记录）
- 错误重试和异常处理
- 频率限制控制

### 用户体验优化

- 可视化OAuth授权流程
- 用户信息显示和授权状态管理
- 实时进度显示
- 详细的状态反馈
- 错误信息提示
- 成功后自动跳转

## 注意事项

1. **应用类型**：必须创建个人应用，不是企业应用
2. **重定向URL**：必须正确配置重定向URL `http://localhost:3000/feishu/callback`
3. **权限配置**：确保个人应用具有多维表格的创建和编辑权限
4. **用户授权**：首次使用需要完成OAuth授权流程
5. **API限制**：飞书API有频率限制，大量数据导出可能需要较长时间
6. **数据安全**：App Secret 安全存储在本地，请妥善保管
7. **AI分析**：启用AI分析会显著增加导出时间，但提供更丰富的数据洞察
8. **网络连接**：需要稳定的网络连接访问飞书API
9. **文档管理**：文档创建到个人空间，可以自由管理和分享

## 故障排除

### 常见问题

1. **授权失败**
   - 检查App ID和App Secret是否正确
   - 确认重定向URL配置正确
   - 验证飞书应用权限配置
   - 检查应用类型是否为个人应用

2. **连接测试失败**
   - 确认网络连接正常
   - 检查应用是否已发布（个人应用需要发布后才能使用）
   - 验证权限范围是否包含多维表格

3. **导出失败**
   - 检查用户授权是否有效
   - 确认选定时间段是否有聊天记录
   - 确认AI服务配置正常（如启用AI分析）
   - 查看日志获取详细错误信息

4. **表格创建失败**
   - 确认用户已完成授权
   - 检查个人飞书空间容量是否充足
   - 验证多维表格权限是否正确

## OAuth授权流程说明

1. **生成授权URL**：应用生成包含App ID、重定向URL等参数的授权URL
2. **用户授权**：用户在浏览器中访问授权URL并登录飞书账户
3. **授权回调**：用户同意授权后，飞书重定向到指定URL并携带授权码
4. **获取令牌**：应用使用授权码换取用户访问令牌和刷新令牌
5. **访问API**：使用用户访问令牌调用飞书API创建个人文档
6. **令牌刷新**：访问令牌过期时自动使用刷新令牌获取新令牌

## 更新历史

- **v2.0.0**: 个人用户级API支持
  - 从企业级应用改为个人应用
  - 实现OAuth2.0授权流程
  - 文档创建到个人空间
  - 用户授权状态管理
  - 令牌自动刷新机制
  
- **v1.0.0**: 基础飞书导出功能（已废弃）
  - 企业级应用支持
  - 聊天记录导出
  - AI智能分析
  - 多维表格自动创建 